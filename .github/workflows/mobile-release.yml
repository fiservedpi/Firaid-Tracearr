name: Mobile Release

on:
  push:
    tags:
      - 'v*'

concurrency:
  group: mobile-release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # Check if this is a prerelease (alpha, beta, rc)
  check-release-type:
    name: Check Release Type
    runs-on: ubuntu-latest
    outputs:
      prerelease: ${{ steps.check.outputs.prerelease }}
      previous_tag: ${{ steps.prev_tag.outputs.tag }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if prerelease
        id: check
        run: |
          TAG="${{ github.ref_name }}"
          if [[ "$TAG" == *-* ]]; then
            echo "prerelease=true" >> "$GITHUB_OUTPUT"
            echo "This is a prerelease: $TAG"
          else
            echo "prerelease=false" >> "$GITHUB_OUTPUT"
            echo "This is a stable release: $TAG"
          fi

      - name: Get previous tag
        id: prev_tag
        run: |
          TAG="${{ github.ref_name }}"
          PREV_TAG=$(git describe --tags --abbrev=0 "${TAG}^" 2>/dev/null || echo "")
          echo "tag=$PREV_TAG" >> "$GITHUB_OUTPUT"
          echo "Previous tag: $PREV_TAG"

  # Check if mobile code changed since last tag
  check-mobile-changes:
    name: Check Mobile Changes
    runs-on: ubuntu-latest
    needs: [check-release-type]
    if: needs.check-release-type.outputs.prerelease == 'true'
    outputs:
      mobile_changed: ${{ steps.check.outputs.changed }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for mobile changes
        id: check
        run: |
          PREV_TAG="${{ needs.check-release-type.outputs.previous_tag }}"
          CURRENT_TAG="${{ github.ref_name }}"

          if [ -z "$PREV_TAG" ]; then
            echo "No previous tag found, assuming mobile changed"
            echo "changed=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Check if any files in apps/mobile changed
          CHANGES=$(git diff --name-only "$PREV_TAG" "$CURRENT_TAG" -- apps/mobile/ | wc -l)

          if [ "$CHANGES" -gt 0 ]; then
            echo "changed=true" >> "$GITHUB_OUTPUT"
            echo "Mobile changes detected: $CHANGES files"
            git diff --name-only "$PREV_TAG" "$CURRENT_TAG" -- apps/mobile/
          else
            echo "changed=false" >> "$GITHUB_OUTPUT"
            echo "No mobile changes since $PREV_TAG"
          fi

  # Build and submit iOS to TestFlight
  build-ios:
    name: Build & Submit iOS
    runs-on: ubuntu-latest
    needs: [check-release-type, check-mobile-changes]
    if: |
      needs.check-release-type.outputs.prerelease == 'true' &&
      needs.check-mobile-changes.outputs.mobile_changed == 'true'
    defaults:
      run:
        working-directory: apps/mobile

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        working-directory: .

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Sync version from git tag
        run: |
          # Extract version from tag (v1.2.3-alpha.4 -> 1.2.3)
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"           # Remove 'v' prefix
          VERSION="${VERSION%%-*}"         # Remove prerelease suffix (-alpha.4, -beta.1, etc.)
          echo "Setting app version to: $VERSION"
          # Update app.json with the version
          jq --arg v "$VERSION" '.expo.version = $v' app.json > tmp.json && mv tmp.json app.json
          cat app.json | jq '.expo.version'

      - name: Build and submit iOS
        run: |
          eas build \
            --platform ios \
            --profile preview \
            --auto-submit \
            --submit-profile preview \
            --non-interactive \
            --no-wait
        env:
          EXPO_APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.EXPO_APPLE_APP_SPECIFIC_PASSWORD }}

  # Build and submit Android to Play Store internal track
  build-android:
    name: Build & Submit Android
    runs-on: ubuntu-latest
    needs: [check-release-type, check-mobile-changes]
    if: |
      needs.check-release-type.outputs.prerelease == 'true' &&
      needs.check-mobile-changes.outputs.mobile_changed == 'true'
    defaults:
      run:
        working-directory: apps/mobile

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        working-directory: .

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Sync version from git tag
        run: |
          # Extract version from tag (v1.2.3-alpha.4 -> 1.2.3)
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"           # Remove 'v' prefix
          VERSION="${VERSION%%-*}"         # Remove prerelease suffix (-alpha.4, -beta.1, etc.)
          echo "Setting app version to: $VERSION"
          # Update app.json with the version
          jq --arg v "$VERSION" '.expo.version = $v' app.json > tmp.json && mv tmp.json app.json
          cat app.json | jq '.expo.version'

      - name: Decode Google Service Account
        run: |
          mkdir -p credentials
          echo "${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}" | base64 -d > credentials/google-service-account.json

      - name: Build and submit Android
        run: |
          eas build \
            --platform android \
            --profile preview \
            --auto-submit \
            --submit-profile preview \
            --non-interactive \
            --no-wait

  # Summary job that reports status
  summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [check-release-type, check-mobile-changes, build-ios, build-android]
    if: always()

    steps:
      - name: Report status
        env:
          TAG: ${{ github.ref_name }}
          PRERELEASE: ${{ needs.check-release-type.outputs.prerelease }}
          MOBILE_CHANGED: ${{ needs.check-mobile-changes.outputs.mobile_changed || 'skipped' }}
          IOS_RESULT: ${{ needs.build-ios.result }}
          ANDROID_RESULT: ${{ needs.build-android.result }}
        run: |
          {
            echo "## Mobile Release Summary"
            echo ""
            echo "**Tag**: $TAG"
            echo "**Prerelease**: $PRERELEASE"
            echo "**Mobile Changed**: $MOBILE_CHANGED"
            echo ""

            if [[ "$PRERELEASE" != "true" ]]; then
              echo "ℹ️ Skipped: Not a prerelease (stable releases don't trigger mobile builds)"
            elif [[ "$MOBILE_CHANGED" != "true" ]]; then
              echo "ℹ️ Skipped: No mobile code changes detected"
            else
              echo "### Build Status"
              echo "- iOS: $IOS_RESULT"
              echo "- Android: $ANDROID_RESULT"
              echo ""
              echo "Builds submitted to EAS. Check [Expo dashboard](https://expo.dev) for progress."
            fi
          } >> "$GITHUB_STEP_SUMMARY"
